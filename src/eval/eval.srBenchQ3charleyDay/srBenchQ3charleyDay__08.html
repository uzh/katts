<html title="sankey">

<style>
.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}
.node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}
.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}
.link:hover {
  stroke-opacity: .5;
}
</style>
<title>srBenchQ3charleyDay__08</title>
<body>
<p id="chart">
<script type="text/javascript" src="http://d3js.org/d3.v2.min.js"></script>
<script type="text/javascript" src="https://raw.github.com/d3/d3-plugins/master/sankey/sankey.js"></script>
<script>
var units = "Messages";

var margin = {top: 10, right: 10, bottom: 10, left: 10},
    width = 2000 - margin.left - margin.right,
    height = 3500 - margin.top - margin.bottom;

var formatNumber = d3.format(",.0f"),    // zero decimal places
    format = function(d) { return formatNumber(d) + " " + units; },
    color = d3.scale.category20();

// append the svg canvas to the page
var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", 
          "translate(" + margin.left + "," + margin.top + ")");

// Set the sankey diagram properties
var sankey = d3.sankey()
    .nodeWidth(36)
    .nodePadding(40)
    .size([width, height]);

var path = sankey.link();

graph = JSON.parse('{"nodes":[{"name":"35"},{"name":"36"},{"name":"33"},{"name":"34"},{"name":"39"},{"name":"37"},{"name":"38"},{"name":"43"},{"name":"42"},{"name":"41"},{"name":"40"},{"name":"22"},{"name":"23"},{"name":"24"},{"name":"25"},{"name":"26"},{"name":"27"},{"name":"28"},{"name":"29"},{"name":"3"},{"name":"2"},{"name":"1"},{"name":"7"},{"name":"30"},{"name":"6"},{"name":"32"},{"name":"5"},{"name":"31"},{"name":"4"},{"name":"9"},{"name":"8"},{"name":"19"},{"name":"17"},{"name":"18"},{"name":"15"},{"name":"16"},{"name":"13"},{"name":"14"},{"name":"11"},{"name":"12"},{"name":"21"},{"name":"20"},{"name":"109"},{"name":"108"},{"name":"107"},{"name":"106"},{"name":"105"},{"name":"104"},{"name":"103"},{"name":"99"},{"name":"102"},{"name":"101"},{"name":"100"},{"name":"98"},{"name":"97"},{"name":"96"},{"name":"95"},{"name":"94"},{"name":"93"},{"name":"92"},{"name":"91"},{"name":"90"},{"name":"10"},{"name":"88"},{"name":"89"},{"name":"116"},{"name":"117"},{"name":"79"},{"name":"114"},{"name":"78"},{"name":"77"},{"name":"115"},{"name":"112"},{"name":"113"},{"name":"110"},{"name":"111"},{"name":"118"},{"name":"119"},{"name":"82"},{"name":"83"},{"name":"80"},{"name":"81"},{"name":"86"},{"name":"87"},{"name":"84"},{"name":"85"},{"name":"67"},{"name":"66"},{"name":"69"},{"name":"68"},{"name":"70"},{"name":"71"},{"name":"72"},{"name":"73"},{"name":"74"},{"name":"75"},{"name":"76"},{"name":"59"},{"name":"64"},{"name":"65"},{"name":"62"},{"name":"63"},{"name":"60"},{"name":"61"},{"name":"48"},{"name":"45"},{"name":"44"},{"name":"47"},{"name":"46"}],"links":[{"source":"30","value":3458,"target":"88"},{"source":"106","value":37,"target":"119"},{"source":"1","value":3295,"target":"59"},{"source":"64","value":23,"target":"119"},{"source":"15","value":3188,"target":"73"},{"source":"117","value":46426,"target":"30"},{"source":"108","value":38298,"target":"9"},{"source":"98","value":34,"target":"119"},{"source":"110","value":41637,"target":"11"},{"source":"109","value":40974,"target":"22"},{"source":"108","value":36824,"target":"21"},{"source":"19","value":2683,"target":"77"},{"source":"113","value":35510,"target":"26"},{"source":"94","value":20,"target":"119"},{"source":"41","value":3208,"target":"99"},{"source":"118","value":38334,"target":"7"},{"source":"32","value":3325,"target":"90"},{"source":"101","value":94,"target":"119"},{"source":"75","value":35,"target":"119"},{"source":"96","value":26,"target":"119"},{"source":"115","value":38075,"target":"28"},{"source":"36","value":2929,"target":"94"},{"source":"34","value":3191,"target":"92"},{"source":"113","value":33355,"target":"38"},{"source":"107","value":40098,"target":"8"},{"source":"107","value":35959,"target":"20"},{"source":"85","value":63,"target":"119"},{"source":"109","value":36838,"target":"10"},{"source":"47","value":3278,"target":"105"},{"source":"111","value":37769,"target":"48"},{"source":"12","value":3545,"target":"70"},{"source":"39","value":3107,"target":"97"},{"source":"88","value":45,"target":"119"},{"source":"91","value":17,"target":"119"},{"source":"38","value":2868,"target":"96"},{"source":"105","value":46,"target":"119"},{"source":"20","value":3065,"target":"78"},{"source":"27","value":3180,"target":"85"},{"source":"40","value":2748,"target":"98"},{"source":"107","value":45115,"target":"32"},{"source":"110","value":36715,"target":"35"},{"source":"113","value":41344,"target":"2"},{"source":"109","value":43692,"target":"46"},{"source":"10","value":2774,"target":"68"},{"source":"111","value":35781,"target":"36"},{"source":"37","value":3069,"target":"95"},{"source":"118","value":41654,"target":"43"},{"source":"115","value":34271,"target":"40"},{"source":"77","value":23,"target":"119"},{"source":"21","value":3100,"target":"79"},{"source":"48","value":2928,"target":"106"},{"source":"76","value":38,"target":"119"},{"source":"117","value":38730,"target":"42"},{"source":"116","value":38284,"target":"41"},{"source":"84","value":95,"target":"119"},{"source":"17","value":3149,"target":"75"},{"source":"109","value":37727,"target":"34"},{"source":"22","value":2945,"target":"80"},{"source":"110","value":34705,"target":"23"},{"source":"73","value":37,"target":"119"},{"source":"112","value":45424,"target":"1"},{"source":"14","value":3627,"target":"72"},{"source":"78","value":30,"target":"119"},{"source":"111","value":34344,"target":"24"},{"source":"90","value":39,"target":"119"},{"source":"71","value":41,"target":"119"},{"source":"107","value":36731,"target":"44"},{"source":"112","value":42009,"target":"25"},{"source":"25","value":3029,"target":"83"},{"source":"45","value":3589,"target":"103"},{"source":"104","value":21,"target":"119"},{"source":"43","value":3604,"target":"101"},{"source":"92","value":22,"target":"119"},{"source":"118","value":41972,"target":"31"},{"source":"67","value":43,"target":"119"},{"source":"100","value":48,"target":"119"},{"source":"24","value":3010,"target":"82"},{"source":"114","value":36875,"target":"27"},{"source":"63","value":12,"target":"119"},{"source":"23","value":2819,"target":"81"},{"source":"74","value":27,"target":"119"},{"source":"115","value":37063,"target":"4"},{"source":"82","value":50,"target":"119"},{"source":"62","value":68,"target":"119"},{"source":"65","value":45,"target":"119"},{"source":"44","value":2896,"target":"102"},{"source":"112","value":36857,"target":"37"},{"source":"35","value":3115,"target":"93"},{"source":"102","value":57,"target":"119"},{"source":"72","value":40,"target":"119"},{"source":"99","value":44,"target":"119"},{"source":"83","value":65,"target":"119"},{"source":"33","value":2915,"target":"91"},{"source":"28","value":3145,"target":"86"},{"source":"31","value":3030,"target":"89"},{"source":"66","value":33,"target":"119"},{"source":"114","value":37656,"target":"39"},{"source":"68","value":46,"target":"119"},{"source":"61","value":31,"target":"119"},{"source":"116","value":40856,"target":"29"},{"source":"93","value":53,"target":"119"},{"source":"114","value":36369,"target":"3"},{"source":"29","value":3336,"target":"87"},{"source":"59","value":45,"target":"119"},{"source":"110","value":40510,"target":"47"},{"source":"103","value":70,"target":"119"},{"source":"118","value":33868,"target":"19"},{"source":"79","value":48,"target":"119"},{"source":"108","value":38909,"target":"33"},{"source":"11","value":3220,"target":"69"},{"source":"87","value":64,"target":"119"},{"source":"7","value":3262,"target":"65"},{"source":"2","value":2979,"target":"60"},{"source":"9","value":3358,"target":"67"},{"source":"70","value":77,"target":"119"},{"source":"13","value":3107,"target":"71"},{"source":"97","value":29,"target":"119"},{"source":"117","value":33421,"target":"18"},{"source":"8","value":3239,"target":"66"},{"source":"3","value":3138,"target":"61"},{"source":"6","value":3293,"target":"64"},{"source":"80","value":19,"target":"119"},{"source":"115","value":37468,"target":"16"},{"source":"116","value":42131,"target":"17"},{"source":"117","value":41816,"target":"6"},{"source":"89","value":29,"target":"119"},{"source":"60","value":15,"target":"119"},{"source":"42","value":3579,"target":"100"},{"source":"108","value":51645,"target":"45"},{"source":"95","value":38,"target":"119"},{"source":"81","value":37,"target":"119"},{"source":"112","value":35417,"target":"13"},{"source":"18","value":2916,"target":"76"},{"source":"111","value":47141,"target":"12"},{"source":"4","value":3080,"target":"62"},{"source":"26","value":2848,"target":"84"},{"source":"113","value":50954,"target":"14"},{"source":"114","value":37788,"target":"15"},{"source":"69","value":37,"target":"119"},{"source":"46","value":3438,"target":"104"},{"source":"16","value":2821,"target":"74"},{"source":"5","value":3284,"target":"63"},{"source":"86","value":54,"target":"119"},{"source":"116","value":39369,"target":"5"}]}');

/************************** Workaround ***************************
  The Sankey.js file expects the "source" and "target" values of the links array, to refer to the respective index of the nodes array. We
  store not indices, but names for the source and target values. The following lines replace these names with their respective index values
  and overrides the values of the links-array in the graph struct afterwards.
*/

// convert links map into
var nameToIndexMap = {};
var nodes = graph.nodes;
for (var i=0; i < nodes.length; i++) {
  nameToIndexMap[nodes[i]["name"]] = i;
}
// now, in the links array, replace all names with their respective index value from the nodes array
var links = graph.links;
for (var i=0; i < links.length; i++) {
  sourceId = links[i]["source"];
  targetId = links[i]["target"];
  links[i]["source"] = nameToIndexMap[sourceId] // example: the map maps name->1
  links[i]["target"] = nameToIndexMap[targetId]
}
graph.links = links // override original
/************************** Workaround ****************************/


  sankey
      .nodes(graph.nodes)
      .links(graph.links)
      .layout(32);

// add in the links
  var link = svg.append("g").selectAll(".link")
      .data(graph.links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", path)
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .sort(function(a, b) { return b.dy - a.dy; });

// add the link titles
  link.append("title")
        .text(function(d) {
            return d.source.name + " → " + 
                d.target.name + "\n" + format(d.value); });

// add in the nodes
  var node = svg.append("g").selectAll(".node")
      .data(graph.nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { 
          return "translate(" + d.x + "," + d.y + ")"; })
    .call(d3.behavior.drag()
      .origin(function(d) { return d; })
      .on("dragstart", function() { 
          this.parentNode.appendChild(this); })
      .on("drag", dragmove));

// add the rectangles for the nodes
  node.append("rect")
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
      .style("fill", function(d) { 
          return d.color = color(d.name.replace(/ .*/, "")); })
      .style("stroke", function(d) { 
          return d3.rgb(d.color).darker(2); })
    .append("title")
      .text(function(d) { 
          return d.name + "\n" + format(d.value); });

// add in the title for the nodes
  node.append("text")
      .attr("x", -6)
      .attr("y", function(d) { return d.dy / 2; })
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) { return d.name; })
    .filter(function(d) { return d.x < width / 2; })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start");

// the function for moving the nodes
  function dragmove(d) {
    d3.select(this).attr("transform", 
        "translate(" + (
            d.x = Math.max(0, Math.min(width - d.dx, d3.event.x))
        )
        + "," + (
            d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
        ) + ")");
    sankey.relayout();
    link.attr("d", path);
  }

</script>
</body>
</html>
